# AWS Batch テンプレート - 本番用コンテナ

このディレクトリには、AWS Batch 用の本番環境向け Docker コンテナをビルドするためのファイルが含まれています。

## 概要

本番用コンテナは、AWS Batch ジョブを本番環境で実行するために最適化されています。uv を使用した高速な依存関係インストールと、最小限のランタイムイメージを組み合わせることで、効率的で軽量なコンテナを実現しています。

## ファイル構成

- `Dockerfile`: 本番用コンテナのビルド定義
- `build_and_push.sh`: Docker イメージをビルドし、ECR にプッシュするスクリプト
- `pyproject.toml`: プロジェクトの依存関係定義
- `uv.lock`: uv によって生成された依存関係のロックファイル
- `run_batch.py`: バッチ処理を実行するメインスクリプト

## 前提条件

- Docker
- AWS CLI（設定済み）
- ECR リポジトリへのアクセス権限

## 使用方法

### 1. Docker イメージのビルドとプッシュ

以下のコマンドを実行して、Docker イメージをビルドし、ECR にプッシュします：

```bash
./build_and_push.sh
```

スクリプトは以下の処理を行います：

- AWS ECR へのログイン
- Docker イメージのビルド（x86_64 アーキテクチャ向け）
- ECR へのイメージプッシュ

### マルチステージビルド

Dockerfile は 2 つのステージで構成されています：

1. **ビルドステージ**: 依存関係のインストールを行います

   - uv を使用して依存関係を効率的にインストール
   - Git と必要なビルドツールを含む

2. **ランタイムステージ**: 実際の実行環境を構築します
   - 最小限のランタイム環境
   - 非特権ユーザーとして実行

### uv

この Dockerfile ではパッケージマネージャとして[uv](https://github.com/astral-sh/uv)を使用しています。uv の特徴：

- 高速なパッケージインストール
- 再現性のあるビルドを実現するロックファイル
- Python パッケージのコンパイル

## トラブルシューティング

ビルドエラーが発生した場合は、以下を確認してください：

1. AWS CLI が正しく設定されているか
2. ECR リポジトリが存在し、適切なアクセス権限があるか
3. `pyproject.toml`の依存関係が正確か
4. 依存関係で指定されている Git リポジトリにアクセスできるか
