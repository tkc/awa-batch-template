# AWS Batch の EC2 と Fargate のオートスケーリング比較

## 目次

1. [はじめに](#はじめに)
2. [スケーリングアプローチの根本的な違い](#スケーリングアプローチの根本的な違い)
3. [オートスケーリング機能の比較](#オートスケーリング機能の比較)
4. [ユースケース別の選択ガイド](#ユースケース別の選択ガイド)
5. [性能とコストの考慮点](#性能とコストの考慮点)
6. [まとめ](#まとめ)

## はじめに

AWS Batch では、コンピューティングリソースとして EC2 と Fargate の 2 つのオプションを利用できます。どちらもオートスケーリング機能を備えていますが、その仕組みと特性には重要な違いがあります。このドキュメントでは、両者のオートスケーリングの違いを詳しく解説し、適切な選択の指針を提供します。

## スケーリングアプローチの根本的な違い

### EC2 のスケーリングモデル

EC2 ベースの AWS Batch では、Auto Scaling グループを使用したインスタンスレベルのスケーリングを行います：

- **インスタンスベース**：ジョブの需要に応じて EC2 インスタンスが追加・削除される
- **ウォームプール**：`minvCpus`設定により、常に一定数のリソースを維持できる
- **インスタンス管理**：起動テンプレート、セキュリティグループ、インスタンスタイプなどの管理が必要

### Fargate のスケーリングモデル

Fargate は完全なサーバーレスアプローチをとります：

- **タスクベース**：個々のタスク（ジョブ）単位でリソースが割り当てられる
- **純粋なオンデマンド**：タスクがないときはリソースも存在せず、`minvCpus`の概念がない
- **インフラ抽象化**：基盤となるインフラストラクチャの管理が不要

## オートスケーリング機能の比較

| 機能                   | EC2 Batch                              | Fargate Batch                       |
| ---------------------- | -------------------------------------- | ----------------------------------- |
| スケーリング単位       | インスタンスレベル                     | タスク（ジョブ）レベル              |
| リソース制御パラメータ | minvCpus, maxvCpus, desiredvCpus       | maxvCpus のみ                       |
| スケーリング粒度       | インスタンスサイズに依存               | タスク単位で正確                    |
| 最小キャパシティ       | 設定可能（minvCpus）                   | 常に 0（設定不可）                  |
| アイドルコスト         | あり（最小インスタンス分）             | なし（使用時のみ課金）              |
| スケールアウト時間     | インスタンス起動時間（1〜3 分程度）    | 数十秒程度                          |
| スケールイン           | アイドルインスタンスを終了             | タスク完了と同時に自動終了          |
| インスタンスタイプ選択 | 詳細な指定が可能                       | 不要（vCPU とメモリのみ指定）       |
| リソースのカスタマイズ | 高（多様なインスタンスタイプから選択） | 中（vCPU とメモリの組み合わせのみ） |

### EC2 固有のオートスケーリング設定

```bash
# EC2環境では以下のパラメータが使用可能
aws batch create-compute-environment \
    --compute-environment-name ec2-compute-env \
    --compute-resources type=EC2,\
       minvCpus=4,\  # 常に維持される最小vCPU数
       desiredvCpus=8,\ # 現在目標とするvCPU数
       maxvCpus=256,\ # 最大スケールアップ制限
       instanceTypes=c5.large,m5.large,r5.large \
    # 他のパラメータ省略
```

### Fargate 固有のオートスケーリング設定

```bash
# Fargate環境では利用可能なパラメータが限定的
aws batch create-compute-environment \
    --compute-environment-name fargate-compute-env \
    --compute-resources type=FARGATE,\
       maxvCpus=256 \ # 唯一の制限パラメータ
    # 他のパラメータ省略
```

## ユースケース別の選択ガイド

### EC2 が適しているケース

1. **常時リソース確保が必要なワークロード**

   - 緊急性の高いジョブを常に即時実行したい場合
   - コールドスタートの時間を許容できないケース
   - スケーリングの予測可能性が重要な場合

2. **特殊なハードウェア要件がある場合**

   - GPU、高メモリなど特殊なインスタンスタイプが必要
   - インスタンスタイプを細かく制御したいケース
   - 特定の CPU アーキテクチャが要件の場合

3. **長時間実行ジョブの大量処理**
   - スポットインスタンスを活用したコスト最適化が重要
   - インスタンスレベルでのキャパシティ管理が必要

### Fargate が適しているケース

1. **間欠的なワークロード**

   - ジョブ実行頻度が不定期
   - アイドル時間にコストをかけたくない場合
   - 完全な従量課金モデルが望ましい場合

2. **管理オーバーヘッドの最小化**

   - インフラ管理を最小限にしたい
   - EC2 インスタンスの選定や管理を避けたい
   - 運用の簡素化が優先事項

3. **小・中規模の処理**
   - 単一タスクのリソース要件が比較的小さい
   - Fargate の上限（16vCPU と 120GB メモリ）内で実行可能

## 性能とコストの考慮点

### 起動遅延の比較

- **EC2**: 新しいインスタンスの起動には 1〜3 分程度かかる場合がある
- **Fargate**: タスクの起動は通常数十秒で完了

### コスト構造の違い

- **EC2**:

  - インスタンス単位の課金
  - minvCpus を設定している場合はアイドル時も課金
  - スポットインスタンスを利用して大幅なコスト削減が可能（最大 90%）

- **Fargate**:
  - タスク実行時間のみの課金
  - アイドルコストなし
  - Fargate Spot を利用してコスト削減可能（最大 70%）

### 実行効率

- **EC2**: インスタンス内のリソース使用効率を最適化する必要がある
- **Fargate**: タスク単位で正確なリソース割り当てが可能

## まとめ

AWS Batch における EC2 と Fargate のオートスケーリングには、それぞれ異なる特性と長所があります：

- **EC2 のオートスケーリング**は、より多くの制御オプションを提供し、常時リソース確保や特殊なハードウェア要件に適しています。`minvCpus`、`desiredvCpus`、`maxvCpus`の 3 つのパラメータでリソースを詳細に制御できますが、インスタンス管理が必要です。

- **Fargate のオートスケーリング**は、純粋なオンデマンドモデルで、タスク単位での柔軟なスケーリングを提供します。管理オーバーヘッドが最小限で、使用したリソースに対してのみ課金されます。ただし、`maxvCpus`以外のスケーリングパラメータはなく、事前のリソース確保はできません。

ワークロードのパターン、管理オーバーヘッド、コスト、応答性の要件に基づいて、適切なオプションを選択することが重要です。多くの場合、小規模で間欠的なワークロードには Fargate が適している一方、常時実行や特殊なリソース要件がある場合は EC2 が適しています。
